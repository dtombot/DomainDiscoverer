---
import BaseLayout from '../../layouts/BaseLayout.astro';
const title = 'Admin Dashboard - Email Manager';
const description = 'Send and view emails via Mailgun. Secured by an admin key.';
---
<BaseLayout {title} {description} robots="noindex,nofollow,noarchive">
  <section class="container-pad">
    <nav aria-label="Breadcrumb" class="text-sm text-slate-600 mb-3">
      <ol class="flex gap-2 items-center">
        <li><a href="/" class="hover:underline">Home</a></li>
        <li>/</li>
        <li aria-current="page">Admin</li>
      </ol>
    </nav>
    <h1 class="text-3xl font-extrabold mb-4">Admin Email Dashboard</h1>

    <!-- Unlock panel: ONLY this is visible by default -->
    <div id="unlock" class="rounded-2xl border border-slate-200 bg-white/80 backdrop-blur-xl shadow p-4 sm:p-5">
      <div class="text-slate-700 text-sm mb-2">Enter your admin key to unlock.</div>
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <input id="admin-key" type="password" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 bg-white" placeholder="Admin key" />
        <button id="btn-unlock" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">Unlock</button>
      </div>
      <div id="unlock-status" class="text-sm text-slate-700 mt-2"></div>
    </div>

    <!-- Admin UI injected only after unlock -->
    <div id="admin-root" class="mt-6"></div>
  </section>

  <!-- Template kept out of DOM so content is not visible until unlocked -->
  <template id="admin-ui">
    <div class="rounded-2xl border border-slate-200 bg-white/80 backdrop-blur-xl shadow p-4 sm:p-5">
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="tab-send" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm font-semibold">Send</button>
        <button id="tab-inbox" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-900 text-sm font-semibold">Inbox</button>
        <button id="tab-sent" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-900 text-sm font-semibold">Sent</button>
        <button id="tab-analytics" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-900 text-sm font-semibold">Analytics</button>
      </div>
      <div id="panel-send">
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-700">To</label>
            <input id="to" type="email" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" placeholder="you@example.com" />
          </div>
          <div>
            <label class="text-sm text-slate-700">Subject</label>
            <input id="subject" type="text" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white" placeholder="Subject" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm text-slate-700">HTML</label>
            <textarea id="html" class="w-full min-h-[160px] px-3 py-2 rounded-lg border border-slate-300 bg-white" placeholder="<p>Hello</p>"></textarea>
          </div>
          <div class="sm:col-span-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm text-slate-700">
              <input id="replyto-enable" type="checkbox" class="rounded border-slate-300" />
              Enable Reply-To
            </label>
            <input id="replyto" type="email" class="flex-1 px-3 py-2 rounded-lg border border-slate-300 bg-white" placeholder="reply@yourdomain.com" disabled />
          </div>
        </div>
        <div class="mt-3 flex items-center gap-3">
          <button id="send" class="px-4 py-2 rounded-xl bg-gradient-to-r from-secondary to-primary text-white font-bold disabled:opacity-60 disabled:cursor-not-allowed">Send</button>
          <div id="send-status" class="text-sm text-slate-700"></div>
        </div>
      </div>
      <div id="panel-inbox" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <label class="text-sm text-slate-700">Event</label>
          <select id="event" class="px-3 py-2 rounded-lg border border-slate-300 bg-white">
            <option value="stored">stored (received)</option>
            <option value="delivered">delivered</option>
            <option value="accepted">accepted</option>
            <option value="opened">opened</option>
            <option value="clicked">clicked</option>
            <option value="failed">failed</option>
            <option value="complained">complained</option>
            <option value="unsubscribed">unsubscribed</option>
            <option value="rejected">rejected</option>
          </select>
          <label class="text-sm text-slate-700 ml-3">Limit</label>
          <select id="limit" class="px-3 py-2 rounded-lg border border-slate-300 bg-white">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
          </select>
          <button id="refresh" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm font-semibold">Refresh</button>
        </div>
        <div id="inbox" class="space-y-2 text-sm"></div>
      </div>
      <div id="panel-sent" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <label class="text-sm text-slate-700">Limit</label>
          <select id="sent-limit" class="px-3 py-2 rounded-lg border border-slate-300 bg-white">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
          </select>
          <button id="refresh-sent" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm font-semibold">Refresh</button>
        </div>
        <div id="sent" class="space-y-2 text-sm"></div>
      </div>
      <div id="panel-analytics" class="hidden">
        <div class="flex items-center gap-2 mb-3">
          <label class="text-sm text-slate-700">Range</label>
          <select id="range" class="px-3 py-2 rounded-lg border border-slate-300 bg-white">
            <option value="24h">Last 24h</option>
            <option value="7d">Last 7 days</option>
            <option value="30d" selected>Last 30 days</option>
            <option value="90d">Last 90 days</option>
          </select>
          <button id="refresh-stats" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm font-semibold">Refresh</button>
        </div>
        <div id="stats" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        <div class="mt-4">
          <div class="text-sm text-slate-700 mb-2">Hourly Trend (24h)</div>
          <div id="trend" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </template>

  <script>
    const KEY_NAME = 'dd_admin_key';
    const unlock = document.getElementById('unlock');
    const keyInput = document.getElementById('admin-key');
    const unlockBtn = document.getElementById('btn-unlock');
    const statusEl = document.getElementById('unlock-status');
    const root = document.getElementById('admin-root');

    const getKey = () => sessionStorage.getItem(KEY_NAME) || '';
    const setKey = (k) => sessionStorage.setItem(KEY_NAME, k);

    async function validateKey(k) {
      try {
        const res = await fetch('/.netlify/functions/admin-verify', { headers: { 'x-admin-key': k } });
        if (!res.ok) return false;
        const data = await res.json().catch(() => ({}));
        return data && (data.status === 'ok');
      } catch { return false; }
    }

    function mountUI() {
      const tpl = document.getElementById('admin-ui');
      if (!tpl) return;
      root.innerHTML = tpl.innerHTML;
      // Wire UI only after mount
      const tabSend = document.getElementById('tab-send');
      const tabInbox = document.getElementById('tab-inbox');
      const tabSent = document.getElementById('tab-sent');
      const tabAnalytics = document.getElementById('tab-analytics');
      const panelSend = document.getElementById('panel-send');
      const panelInbox = document.getElementById('panel-inbox');
      const panelSent = document.getElementById('panel-sent');
      const panelAnalytics = document.getElementById('panel-analytics');
      const toEl = document.getElementById('to');
      const subjectEl = document.getElementById('subject');
      const htmlEl = document.getElementById('html');
      const sendBtn = document.getElementById('send');
      const sendStatus = document.getElementById('send-status');
      const replyToEnable = document.getElementById('replyto-enable');
      const replyToInput = document.getElementById('replyto');
      const inboxEl = document.getElementById('inbox');
      const refreshBtn = document.getElementById('refresh');
      const eventSel = document.getElementById('event');
      const limitSel = document.getElementById('limit');

      // Toast for success/error
      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = 'fixed bottom-4 right-4 z-50 hidden';
      document.body.appendChild(toast);
      function showToast(msg, ok = true) {
        toast.innerHTML = `<div class="px-4 py-3 rounded-xl shadow text-sm ${ok ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">${msg}</div>`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 2400);
      }

      function activate(tab) {
        const allTabs = [tabSend, tabInbox, tabSent, tabAnalytics];
        const allPanels = [panelSend, panelInbox, panelSent, panelAnalytics];
        allTabs.forEach((t) => { t.classList.replace('bg-slate-900','bg-slate-200'); t.classList.remove('text-white'); });
        allPanels.forEach((p) => p.classList.add('hidden'));
        tab.classList.replace('bg-slate-200','bg-slate-900');
        tab.classList.add('text-white');
      }
      tabSend.addEventListener('click', () => { activate(tabSend); panelSend.classList.remove('hidden'); });
      tabInbox.addEventListener('click', () => { activate(tabInbox); panelInbox.classList.remove('hidden'); });
      tabSent.addEventListener('click', () => { activate(tabSent); panelSent.classList.remove('hidden'); loadSent(); });
      tabAnalytics.addEventListener('click', () => { activate(tabAnalytics); panelAnalytics.classList.remove('hidden'); });

      replyToEnable.addEventListener('change', () => {
        replyToInput.disabled = !replyToEnable.checked;
        if (!replyToEnable.checked) replyToInput.value = '';
      });

      sendBtn.addEventListener('click', async () => {
        sendStatus.textContent = 'Sending…';
        sendBtn.disabled = true;
        try {
          const res = await fetch('/.netlify/functions/admin-send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-admin-key': getKey() },
            body: JSON.stringify({
              to: toEl.value,
              subject: subjectEl.value,
              html: htmlEl.value,
              replyTo: replyToEnable.checked ? replyToInput.value : undefined
            })
          });
          const data = await res.json();
          if (data && data.status === 'ok') {
            sendStatus.textContent = '';
            showToast('Sent successfully ✓');
            toEl.value = '';
            subjectEl.value = '';
            htmlEl.value = '';
            replyToEnable.checked = false;
            replyToInput.value = '';
            replyToInput.disabled = true;
          } else {
            const msg = (data && data.message) || 'Error';
            sendStatus.textContent = msg;
            showToast(msg, false);
          }
        } catch (e) {
          sendStatus.textContent = 'Network error';
          showToast('Network error', false);
        } finally {
          sendBtn.disabled = false;
        }
      });

      async function loadInbox() {
        inboxEl.textContent = 'Loading...';
        try {
          const ev = eventSel.value;
          if (ev === 'stored') {
            // Supabase-backed inbox
            const res = await fetch(`/.netlify/functions/admin-list-inbound?limit=${encodeURIComponent(limitSel.value)}`, {
              headers: { 'x-admin-key': getKey() }
            });
            const data = await res.json();
            if (!data || data.status !== 'ok') { inboxEl.textContent = (data && data.message) || 'Error'; return; }
            const items = data.messages || [];
            inboxEl.innerHTML = items.map((it, idx) => {
              const ts = it.received_at ? new Date(it.received_at).toLocaleString() : (it.created_at ? new Date(it.created_at).toLocaleString() : '');
              const from = it.from_email || '';
              const to = it.to_email || '';
              const subject = it.subject || '';
              const viewBtn = `<button data-idx="${idx}" class="btn-view-supa text-xs px-2 py-1 rounded-lg bg-slate-900 text-white">View</button>`;
              return `<div class="rounded-xl border border-slate-200 bg-white/70 p-3 space-y-1">
                <div class="flex items-center justify-between">
                  <div class="text-slate-500 text-xs">${ts}</div>
                  <div class="text-slate-600 text-xs">stored</div>
                </div>
                <div class="font-semibold">${subject}</div>
                <div class="text-slate-600">From: ${from}</div>
                <div class="text-slate-600">To: ${to}</div>
                <div>${viewBtn}</div>
                <div id="body-${idx}" class="prose prose-sm max-w-none hidden"></div>
              </div>`;
            }).join('');

            // Bind view buttons to render content from saved HTML/text
            (items || []).forEach((it, i) => {
              const btn = inboxEl.querySelector(`.btn-view-supa[data-idx="${i}"]`);
              if (!btn) return;
              btn.addEventListener('click', () => {
                const bodyEl = document.getElementById(`body-${i}`);
                if (!bodyEl) return;
                bodyEl.classList.remove('hidden');
                const html = it.body_html || '';
                const text = (it.body_text || '').replace(/\n/g,'<br/>');
                bodyEl.innerHTML = html || `<div class="text-slate-700">${text}</div>` || '<div class="text-slate-500">No content</div>';
              });
            });
          } else {
            // Mailgun events for other types
            const res = await fetch(`/.netlify/functions/admin-list-emails?event=${encodeURIComponent(ev)}&limit=${encodeURIComponent(limitSel.value)}`, {
              headers: { 'x-admin-key': getKey() }
            });
            const data = await res.json();
            if (!data || data.status !== 'ok') { inboxEl.textContent = (data && data.message) || 'Error'; return; }
            const items = data.events || [];
            inboxEl.innerHTML = items.map((it, idx) => {
              const ts = it.timestamp ? new Date(it.timestamp * 1000).toLocaleString() : '';
              const evName = it.event || ev;
              const msg = it.message || {};
              const headers = msg.headers || {};
              const from = headers.from || (it.envelope && it.envelope.sender) || '';
              const to = headers.to || (it.envelope && it.envelope.targets) || '';
              const subject = headers.subject || headers.Subject || it.campaign || evName.toUpperCase();
              const storage = it.storage || {};
              const viewBtn = storage.url ? `<button data-url="${encodeURIComponent(storage.url)}" class="btn-view text-xs px-2 py-1 rounded-lg bg-slate-900 text-white">View</button>` : '';
              return `<div class="rounded-xl border border-slate-200 bg-white/70 p-3 space-y-1">
                <div class="flex items-center justify-between">
                  <div class="text-slate-500 text-xs">${ts}</div>
                  <div class="text-slate-600 text-xs">${evName}</div>
                </div>
                <div class="font-semibold">${subject}</div>
                <div class="text-slate-600">From: ${from}</div>
                <div class="text-slate-600">To: ${to}</div>
                <div>${viewBtn}</div>
                <div id="body-${idx}" class="prose prose-sm max-w-none hidden"></div>
              </div>`;
            }).join('');

            // Wire up Mailgun stored-view buttons (may be blocked on your plan)
            inboxEl.querySelectorAll('.btn-view').forEach((btn, i) => {
              btn.addEventListener('click', async () => {
                const url = decodeURIComponent(btn.getAttribute('data-url'));
                const bodyEl = document.getElementById(`body-${i}`);
                if (!bodyEl) return;
                bodyEl.innerHTML = 'Loading…';
                bodyEl.classList.remove('hidden');
                try {
                  const res = await fetch(`/.netlify/functions/admin-get-stored?url=${encodeURIComponent(url)}`, { headers: { 'x-admin-key': getKey() } });
                  const data = await res.json();
                  if (data && data.status === 'ok') {
                    const m = data.message || {};
                    const html = m['stripped-html'] || m['body-html'] || '';
                    const text = (m['stripped-text'] || m['body-plain'] || '').replace(/\n/g,'<br/>');
                    bodyEl.innerHTML = html || `<div class="text-slate-700">${text}</div>` || '<div class="text-slate-500">No content</div>';
                  } else {
                    bodyEl.innerHTML = `<div class="text-red-600">${(data && data.message) || 'Error'}</div>`;
                  }
                } catch {
                  bodyEl.innerHTML = '<div class="text-red-600">Network error</div>';
                }
              });
            });
          }
        } catch (e) {
          inboxEl.textContent = 'Network error';
        }
      }
      refreshBtn.addEventListener('click', loadInbox);

      // Analytics
      const statsEl = document.getElementById('stats');
      const rangeSel = document.getElementById('range');
      const refreshStatsBtn = document.getElementById('refresh-stats');
      const trendEl = document.getElementById('trend');
      async function loadStats() {
        statsEl.innerHTML = 'Loading…';
        trendEl.innerHTML = '';
        try {
          const range = rangeSel.value;
          const params = new URLSearchParams({ duration: range });
          if (range === '24h') params.append('resolution', '1h');
          const res = await fetch(`/.netlify/functions/admin-stats?${params.toString()}`, { headers: { 'x-admin-key': getKey() } });
          const data = await res.json();
          if (!data || data.status !== 'ok') { statsEl.innerHTML = `<div class=\"text-red-600\">${(data && data.message) || 'Error'}</div>`; return; }
          const t = data.totals || {};
          const cards = [
            ['delivered', 'Delivered'],
            ['opened', 'Opened'],
            ['clicked', 'Clicked'],
            ['failed', 'Failed (bounced)'],
            ['complained', 'Complaints'],
            ['unsubscribed', 'Unsubscribed'],
            ['accepted', 'Accepted'],
            ['stored', 'Received (stored)'],
          ];
          statsEl.innerHTML = cards.map(([k, label]) => {
            const val = t[k] ?? 0;
            return `<div class=\"rounded-xl border border-slate-200 bg-white/70 p-4\"><div class=\"text-slate-500 text-xs\">${label}</div><div class=\"text-3xl font-extrabold\">${val}</div></div>`;
          }).join('');

          // Trend for 24h only
          if (range === '24h' && Array.isArray(data.series)) {
            const focus = ['delivered', 'opened', 'clicked', 'failed'];
            // Compute max per event for scaling
            const maxes = {};
            for (const k of focus) maxes[k] = 0;
            for (const pt of data.series) {
              for (const k of focus) {
                const v = (pt.values && typeof pt.values[k] === 'number') ? pt.values[k] : 0;
                if (v > maxes[k]) maxes[k] = v;
              }
            }
            const row = (label, key) => {
              const bars = (data.series || []).map((pt) => {
                const v = (pt.values && typeof pt.values[key] === 'number') ? pt.values[key] : 0;
                const max = maxes[key] || 1;
                const h = Math.max(2, Math.round((v / max) * 48));
                const ts = pt.time ? new Date(pt.time).toLocaleString() : '';
                return `<div title=\"${label}: ${v} at ${ts}\" class=\"w-2 bg-slate-900 rounded-sm\" style=\"height:${h}px\"></div>`;
              }).join('');
              return `<div>
                <div class=\"text-xs text-slate-600 mb-1\">${label}</div>
                <div class=\"flex items-end gap-1 h-12\">${bars}</div>
              </div>`;
            };
            trendEl.innerHTML = [
              row('Delivered', 'delivered'),
              row('Opened', 'opened'),
              row('Clicked', 'clicked'),
              row('Failed', 'failed'),
            ].join('');
          }
        } catch {
          statsEl.innerHTML = '<div class="text-red-600">Network error</div>';
        }
      }
      refreshStatsBtn.addEventListener('click', loadStats);

      // Sent
      const sentEl = document.getElementById('sent');
      const refreshSentBtn = document.getElementById('refresh-sent');
      const sentLimitSel = document.getElementById('sent-limit');
      async function loadSent() {
        sentEl.textContent = 'Loading…';
        try {
          const res = await fetch(`/.netlify/functions/admin-list-sent?limit=${encodeURIComponent(sentLimitSel.value)}`, { headers: { 'x-admin-key': getKey() } });
          const data = await res.json();
          if (!data || data.status !== 'ok') { sentEl.textContent = (data && data.message) || 'Error'; return; }
          const items = data.messages || [];
          sentEl.innerHTML = items.map((it, idx) => {
            const ts = it.created_at ? new Date(it.created_at).toLocaleString() : '';
            const subject = it.subject || '';
            const from = it.from_email || '';
            const to = it.to_email || '';
            const viewBtn = `<button data-idx="${idx}" class="btn-view-sent text-xs px-2 py-1 rounded-lg bg-slate-900 text-white">View</button>`;
            return `<div class=\"rounded-xl border border-slate-200 bg-white/70 p-3 space-y-1\">\n              <div class=\"flex items-center justify-between\">\n                <div class=\"text-slate-500 text-xs\">${ts}</div>\n                <div class=\"text-slate-600 text-xs\">queued</div>\n              </div>\n              <div class=\"font-semibold\">${subject}</div>\n              <div class=\"text-slate-600\">From: ${from}</div>\n              <div class=\"text-slate-600\">To: ${to}</div>\n              <div>${viewBtn}</div>\n              <div id=\"sent-body-${idx}\" class=\"prose prose-sm max-w-none hidden\"></div>\n            </div>`;
          }).join('');
          (items || []).forEach((it, i) => {
            const btn = sentEl.querySelector(`.btn-view-sent[data-idx=\\"${i}\\"]`);
            if (!btn) return;
            btn.addEventListener('click', () => {
              const bodyEl = document.getElementById(`sent-body-${i}`);
              if (!bodyEl) return;
              const html = it.body_html || '';
              const text = (it.body_text || '').replace(/\n/g,'<br/>');
              bodyEl.classList.remove('hidden');
              bodyEl.innerHTML = html || `<div class=\"text-slate-700\">${text}</div>` || '<div class=\"text-slate-500\">No content</div>';
            });
          });
        } catch (e) {
          sentEl.textContent = 'Network error';
        }
      }
      refreshSentBtn.addEventListener('click', loadSent);
    }

    async function tryAutoUnlock() {
      const k = getKey();
      if (!k) return;
      statusEl.textContent = 'Validating...';
      const ok = await validateKey(k);
      if (ok) {
        unlock.classList.add('hidden');
        mountUI();
      } else {
        statusEl.textContent = 'Invalid key';
      }
    }

    unlockBtn.addEventListener('click', async () => {
      const k = keyInput.value.trim();
      if (!k) { statusEl.textContent = 'Enter a key'; return; }
      statusEl.textContent = 'Validating...';
      const ok = await validateKey(k);
      if (ok) {
        setKey(k);
        unlock.classList.add('hidden');
        mountUI();
      } else {
        statusEl.textContent = 'Invalid key';
      }
    });

    tryAutoUnlock();
  </script>
</BaseLayout>
